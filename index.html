<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Teaching Progress Tracker PWA for tracking vocational training progress">
    <meta name="theme-color" content="#2c3e50">
    <title>Teaching Progress Tracker</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%232c3e50' width='192' height='192'/><text x='50%' y='50%' font-size='120' fill='white' text-anchor='middle' dominant-baseline='middle' font-weight='bold'>üìö</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%232c3e50' width='192' height='192'/><text x='50%' y='50%' font-size='120' fill='white' text-anchor='middle' dominant-baseline='middle' font-weight='bold'>üìö</text></svg>">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Sync Status Indicator (Toast) -->
    <div id="syncIndicator" style="position: fixed; top: 10px; right: 10px; padding: 12px 16px; border-radius: 20px; font-size: 12px; z-index: 10000; display: none; background: #4CAF50; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.15); animation: slideIn 0.3s ease-out;">
        <span id="syncStatus">‚òÅÔ∏è Syncing...</span>
    </div>
    
    <!-- Internet Connection Status -->
    <div id="connectionStatus" style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); padding: 6px 14px; border-radius: 20px; font-size: 11px; z-index: 9999; background: #4CAF50; color: white; display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
        <span id="connectionIndicator">‚óè</span>
        <span id="connectionText">Online</span>
    </div>
    
    <!-- Sync status animations -->
    <style>
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(400px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(400px); }
        }
    </style>
    <div id="app" class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="logo-section">
                <img src="assets/images/logo.png" alt="School Logo" class="logo">
            </div>
            <div class="header-content">
                <h1> Teaching Progress Tracker</h1>
            </div>
            <div class="header-actions">
                <button id="viewTopicsBtn" class="btn btn-secondary" title="View Topics">üìñ View Topics</button>
                <button id="loadTopicsBtn" class="btn btn-secondary" title="Load Topics">üìö Load Topics</button>
                <button id="exportBtn" class="btn btn-secondary" title="Export progress">üì• Export</button>
                <button id="settingsBtn" class="btn btn-secondary" title="Settings">‚öôÔ∏è Settings</button>
            </div>
        </header>

        <!-- Info Bar -->
        <div class="info-bar" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <p class="subtitle">Vocational Training Followup, Tanzania</p>
                <p id="teacherInfo" class="teacher-info"></p>
            </div>
            <div id="headerSyncStatus" style="display: none; font-size: 0.85rem; padding: 6px 12px; background: rgba(76, 175, 80, 0.1); border-left: 3px solid #4CAF50; border-radius: 4px; color: #2c3e50;">
                <span id="headerSyncText">‚è≥ Syncing...</span>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Kanban Board -->
            <section class="kanban-board">
                <!-- Not Started Column -->
                <div class="kanban-column" data-status="not-started">
                    <div class="column-header">
                        <h2>Not Started</h2>
                        <span class="column-count">0</span>
                    </div>
                    <div class="column-content" id="column-not-started">
                        <!-- Cards will be inserted here by JS -->
                    </div>
                    <button class="btn btn-add-card" data-status="not-started">+ Add Topic</button>
                </div>

                <!-- In Progress Column -->
                <div class="kanban-column" data-status="in-progress">
                    <div class="column-header">
                        <h2>In Progress</h2>
                        <span class="column-count">0</span>
                    </div>
                    <div class="column-content" id="column-in-progress">
                        <!-- Cards will be inserted here by JS -->
                    </div>
                    <button class="btn btn-add-card" data-status="in-progress">+ Add Topic</button>
                </div>

                <!-- Completed Column -->
                <div class="kanban-column" data-status="completed">
                    <div class="column-header">
                        <h2>Completed</h2>
                        <span class="column-count">0</span>
                    </div>
                    <div class="column-content" id="column-completed">
                        <!-- Cards will be inserted here by JS -->
                    </div>
                    <button class="btn btn-add-card" data-status="completed">+ Add Topic</button>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <p>2026 ¬© Designed by THE ONE TECH SERVICES COMPANY LTD ‚Ä¢ All rights reserved.</p>
        </footer>
    </div>

    <!-- Modal for Adding/Editing Lessons -->
    <div id="lessonModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add New Topic</h2>
                <button class="modal-close" id="closeModalBtn">&times;</button>
            </div>
            <form id="lessonForm" class="modal-body">
                <div class="form-group">
                    <label for="topicName">Topic Name *</label>
                    <input type="text" id="topicName" name="topic" required placeholder="e.g., Introduction to Computer">
                </div>

                <div class="form-group">
                    <label for="week">Week Number</label>
                    <input type="number" id="week" name="week" min="1" max="52" placeholder="e.g., 1">
                </div>

                <div class="form-group">
                    <label for="periodsPlanned">Periods Planned</label>
                    <input type="number" id="periodsPlanned" name="periodsPlanned" min="0" value="2">
                </div>

                <div class="form-group">
                    <label for="periodsUsed">Periods Used</label>
                    <input type="number" id="periodsUsed" name="periodsUsed" min="0" value="0">
                </div>

                <div class="form-group">
                    <label for="lastTaught">Last Taught Date</label>
                    <input type="date" id="lastTaught" name="lastTaught">
                </div>

                <div class="form-group">
                    <label for="nextStart">Next Start Point</label>
                    <input type="text" id="nextStart" name="nextStart" placeholder="e.g., Page 3, Exercise 5">
                </div>

                <div class="form-group">
                    <label for="remarks">Remarks / Notes</label>
                    <textarea id="remarks" name="remarks" rows="3" placeholder="Any notes about this topic..."></textarea>
                </div>

                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status" name="status" required>
                        <option value="not-started">Not Started</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>

                <div class="form-actions">
                    <button type="button" id="cancelBtn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Topic</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Auth Landing Page -->
    <div id="authLanding" class="modal" style="display: flex;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>üìö Teaching Progress Tracker</h2>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p style="font-size: 1rem; margin-bottom: var(--spacing-lg);">Welcome to your teaching companion app</p>
                <button id="loginBtn" type="button" class="btn btn-primary btn-block" style="margin-bottom: var(--spacing-md);">üîê Login</button>
                <button id="createProfileBtn" type="button" class="btn btn-secondary btn-block">‚ú® Create New Profile</button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Login</h2>
                <button class="modal-close" id="backFromLoginBtn" type="button">&times;</button>
            </div>
            <form id="loginForm" class="modal-body">
                <div class="form-group">
                    <label for="loginTeacherName">Teacher Name *</label>
                    <input type="text" id="loginTeacherName" name="teacherName" required placeholder="Enter your name">
                </div>

                <div class="form-group">
                    <label for="loginPassword">Password *</label>
                    <input type="password" id="loginPassword" name="password" required placeholder="Enter your password">
                </div>

                <div class="form-actions">
                    <button type="button" id="backLoginBtn" class="btn btn-secondary">Back</button>
                    <button type="submit" class="btn btn-primary">Login</button>
                </div>
                
                <div style="text-align: center; margin-top: 1rem;">
                    <button type="button" id="forgotPasswordBtn" class="btn btn-link" style="background: none; border: none; color: #3498db; cursor: pointer; text-decoration: underline;">üîë Forgot Password?</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Reset Password</h2>
                <button class="modal-close" id="closeForgotPasswordBtn" type="button">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Step 1: Verification -->
                <div id="resetVerificationStep" style="display: block;">
                    <p style="color: #666; margin-bottom: var(--spacing-lg);">Enter your registration details to verify your identity</p>
                    
                    <div class="form-group">
                        <label for="resetTeacherName">Teacher Name *</label>
                        <input type="text" id="resetTeacherName" placeholder="Enter your full name">
                    </div>
                    
                    <div class="form-group">
                        <label>Verification Method *</label>
                        <select id="resetVerificationMethod" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Select verification method</option>
                            <option value="email">Email</option>
                            <option value="phone">Phone Number</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="resetVerificationValue">Your Email or Phone *</label>
                        <input type="text" id="resetVerificationValue" placeholder="Enter your email or phone number">
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" id="resetBackBtn" class="btn btn-secondary">Back</button>
                        <button type="button" id="resetVerifyBtn" class="btn btn-primary">Verify & Continue</button>
                    </div>
                </div>
                
                <!-- Step 2: Reset Password -->
                <div id="resetPasswordStep" style="display: none;">
                    <p style="color: #27ae60; margin-bottom: var(--spacing-lg);">‚úÖ Identity verified! Now set your new password</p>
                    
                    <div class="form-group">
                        <label for="resetNewPassword">New Password *</label>
                        <input type="password" id="resetNewPassword" placeholder="Min 8 chars: Uppercase, lowercase, numbers + special chars">
                    </div>
                    
                    <div class="form-group">
                        <label for="resetConfirmPassword">Confirm Password *</label>
                        <input type="password" id="resetConfirmPassword" placeholder="Confirm your new password">
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" id="resetBackToVerifyBtn" class="btn btn-secondary">Back</button>
                        <button type="button" id="resetSubmitBtn" class="btn btn-primary">Reset Password</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Profile Modal -->
    <div id="createProfileModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create Your Profile</h2>
                <button class="modal-close" id="backFromCreateBtn" type="button">&times;</button>
            </div>
            <form id="profileForm" class="modal-body">
                <div class="form-group">
                    <label for="teacherName">Teacher Name *</label>
                    <input type="text" id="teacherName" name="teacherName" required placeholder="Your full name">
                </div>

                <div class="form-group" style="display: none;">
                    <label for="subjectName">Subject/Course Name *</label>
                    <input type="text" id="subjectName" name="subjectName" placeholder="You will select this next">
                </div>

                <div class="form-group">
                    <label for="password">Password *</label>
                    <input type="password" id="password" name="password" required placeholder="Min 8 chars: Uppercase, lowercase, numbers + special chars">
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirm Password *</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Confirm your password">
                </div>

                <div class="form-group">
                    <label for="schoolName">School Name</label>
                    <input type="text" id="schoolName" name="schoolName" placeholder="School name">
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" placeholder="your.email@school.com">
                </div>

                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" name="phone" placeholder="+255 xxx xxx xxx">
                </div>

                <div class="form-group">
                    <label for="classroom">Classroom/Class Level</label>
                    <input type="text" id="classroom" name="classroom" placeholder="e.g., Level One">
                </div>

                <div class="form-actions">
                    <button type="button" id="backCreateBtn" class="btn btn-secondary">Back</button>
                    <button type="submit" class="btn btn-primary">Create Profile</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Subject Selection Modal -->
    <div id="subjectSelectionModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Select Your Subject/Course</h2>
                <button class="modal-close" id="closeSubjectSelectionBtn">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: var(--spacing-lg); color: var(--text-secondary);">Choose the vocational subject you teach:</p>
                <div id="subjectGrid" style="display: grid; grid-template-columns: 1fr; gap: var(--spacing-md);">
                    <!-- Subjects will be populated by JavaScript -->
                </div>
                <div class="form-actions" style="margin-top: var(--spacing-lg);">
                    <button type="button" id="submitSubjectBtn" class="btn btn-primary" style="width: 100%;">Continue</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Topics Modal -->
    <div id="viewTopicsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>All Topics</h2>
                <button class="modal-close" id="closeViewTopicsModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: var(--spacing-lg);">
                    <input type="text" id="topicsSearchInput" placeholder="Search topics..." style="width: 100%; padding: var(--spacing-md); border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.95rem;">
                </div>
                <div id="topicsListContainer" style="max-height: 60vh; overflow-y: auto;">
                    <!-- Topics will be populated here by JavaScript -->
                </div>
                <div class="form-actions" style="margin-top: var(--spacing-lg);">
                    <button id="closeViewTopicsBtn" class="btn btn-secondary">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal" style="display: none;">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>Change Password</h2>
                <button class="modal-close" id="closeChangePasswordModalBtn">&times;</button>
            </div>
            <form id="changePasswordForm" class="modal-body">
                <div class="form-group">
                    <label for="currentPassword">Current Password *</label>
                    <input type="password" id="currentPassword" name="currentPassword" required placeholder="Enter current password">
                </div>

                <div class="form-group">
                    <label for="newPassword">New Password *</label>
                    <input type="password" id="newPassword" name="newPassword" required placeholder="Enter new password (min 4 characters)">
                </div>

                <div class="form-group">
                    <label for="confirmNewPassword">Confirm New Password *</label>
                    <input type="password" id="confirmNewPassword" name="confirmNewPassword" required placeholder="Confirm new password">
                </div>

                <div class="form-actions">
                    <button type="button" id="cancelChangePasswordBtn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Change Password</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Load Topics Modal -->
    <div id="loadTopicsModal" class="modal" style="display: none;">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>Load Topics</h2>
                <button class="modal-close" id="closeLoadTopicsModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <p>Select an option:</p>
                <button id="loadDefaultTopicsFormBtn" class="btn btn-primary btn-block">üìö Load Standard Curriculum</button>
                <button id="loadFromFileBtn" class="btn btn-secondary btn-block">üìÅ Import from File</button>
                <div class="form-actions" style="margin-top: var(--spacing-lg);">
                    <button id="closeLoadTopicsBtn" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal" style="display: none;">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>Export Progress</h2>
                <button class="modal-close" id="closeExportModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <button id="exportCSV" class="btn btn-primary btn-block">üìä Export as CSV</button>
                <button id="exportPDF" class="btn btn-primary btn-block">üìÑ Export as PDF Summary</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal" style="display: none;">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="modal-close" id="closeSettingsModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <h3>Teacher Profile</h3>
                    <button id="editProfileBtn" class="btn btn-primary btn-block">üë§ View Profile</button>
                    <button id="changePasswordBtn" class="btn btn-secondary btn-block" style="margin-top: var(--spacing-sm);">üîê Change Password</button>
                    <button id="logoutBtn" class="btn btn-danger btn-block" style="margin-top: var(--spacing-sm);">üö™ Logout</button>
                </div>

                <div class="form-group">
                    <h3>Database Actions</h3>
                    <button id="loadDefaultTopicsBtn" class="btn btn-primary btn-block">üìö Available Topics</button>
                    <p style="font-size: 0.75rem; margin-top: var(--spacing-sm); color: #27ae60;">For new users or different teachers</p>
                </div>
                <div class="form-group">
                    <button id="forceResetBtn" class="btn btn-danger btn-block">üîÑ Force Reset Database</button>
                    <p class="warning" style="font-size: 0.75rem; margin-top: var(--spacing-sm);">Delete all and restore defaults.</p>
                </div>

                <div class="form-actions">
                    <button id="closeSettingsBtn" class="btn btn-secondary">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div id="profileSettingsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Profile Settings</h2>
                <button class="modal-close" id="closeProfileSettingsBtn">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Profile Info Display -->
                <div class="form-group" style="background: rgba(0,0,0,0.05); padding: var(--spacing-md); border-radius: var(--border-radius);">
                    <p style="margin: 0;"><strong>Teacher:</strong> <span id="displayTeacherName"></span></p>
                    <p style="margin: var(--spacing-sm) 0 0 0;"><strong>Subject:</strong> <span id="displaySubject"></span></p>
                    <p style="margin: var(--spacing-sm) 0 0 0;"><strong>Phone:</strong> <span id="displayPhone"></span></p>
                </div>

                <!-- Profile Actions -->
                <div class="form-group">
                    <h3 style="margin-top: var(--spacing-lg);">Profile Management</h3>
                    <button id="editNameBtn" class="btn btn-primary btn-block">‚úèÔ∏è Edit Name</button>
                    <button id="editPhoneBtn" class="btn btn-primary btn-block" style="margin-top: var(--spacing-sm);">üì± Edit Phone</button>
                </div>

                <!-- Topics Management -->
                <div class="form-group">
                    <h3>Topics Management</h3>
                    <button id="viewTopicListBtn" class="btn btn-secondary btn-block">üìã View Topic List</button>
                    <button id="deleteTopicBtn" class="btn btn-secondary btn-block" style="margin-top: var(--spacing-sm);">üóëÔ∏è Delete Topic</button>
                </div>

                <!-- Schedule -->
                <div class="form-group">
                    <h3>üìÖ Schedule</h3>
                    <button id="nextPeriodBtn" class="btn btn-secondary btn-block">Set Next Period Schedule</button>
                </div>

                <div class="form-actions">
                    <button id="backProfileSettingsBtn" class="btn btn-secondary">Back</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal" style="display: none;">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>Delete Topic?</h2>
                <button class="modal-close" id="closeDeleteModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete "<span id="deleteTopicName"></span>"?</p>
                <p class="warning">This action cannot be undone.</p>
                <div class="form-actions">
                    <button id="cancelDeleteBtn" class="btn btn-secondary">Cancel</button>
                    <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Firebase MUST load first - using compat version for global variable support -->
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore-compat.js"></script>
    
    <!-- Wait for Firebase to load, then load app scripts -->
    <script>
        // Ensure Firebase is loaded before proceeding
        (async function() {
            let attempts = 0;
            while (!window.firebase && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            if (window.firebase) {
                console.log('‚úì Firebase ready, loading app scripts');
                // Load remaining scripts
                const scripts = [
                    'js/firebase-config.js',
                    'js/security.js',
                    'js/db.js',
                    'js/ui.js',
                    'js/app.js'
                ];
                
                for (const src of scripts) {
                    const script = document.createElement('script');
                    script.src = src;
                    document.body.appendChild(script);
                    // Small delay between scripts to ensure proper initialization
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
            } else {
                console.error('‚úó Firebase failed to load');
            }
        })();
    </script>

    <!-- Register Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => console.log('SW registered'))
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>
</body>
</html>
